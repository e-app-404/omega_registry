# Consolidated Rehydration Manifest (2025-07-04)

## Artifact Status Overview

| Artifact                                             | Path                                                     | Status                                               |
|------------------------------------------------------|----------------------------------------------------------|------------------------------------------------------|
| ✅ omega_device_registry.cleaned.v2.json              | output/omega_device_registry.cleaned.v2.json             | Generated from raw core.device_registry              |
| ✅ omega_device_registry.enriched.canonical.json      | output/omega_device_registry.enriched.canonical.json     | Enriched via enrich_omega_device_registry_stage2.py  |
| ✅ omega_device_registry.enriched.canonical.patched.json | output/omega_device_registry.enriched.canonical.patched.json | Patched with area_id, room, zone                 |
| ✅ omega_device_registry.enriched.canonical.devtools_enriched.json | output/omega_device_registry.enriched.canonical.devtools_enriched.json | Enriched with devtools tags         |
| ✅ omega_device_registry.normalized.enriched.json     | output/omega_device_registry.normalized.enriched.json    | Final canonical registry                            |
| ✅ alpha_sensor_registry.json                         | output/alpha_sensor_registry.json                        | Rehydrated, clustered, feature-merged                |
| ✅ core.area_registry                                | input/core.area_registry                                 | Live registry loaded from HA                         |
| ✅ core.device_registry                              | input/core.device_registry                               | Live registry loaded from HA                         |
| ✅ core.entity_registry                              | input/core.entity_registry                               | Live registry loaded from HA                         |
| ✅ fingerprint_entity_clusters.v1.json                | output/fingerprint_entity_clusters.v1.json               | Clustered fingerprint output                         |
| ✅ entity_id_migration_map.annotated.v4.json          | output/entity_id_migration_map.annotated.v4.json         | Post-fingerprint ID migration map                    |
| ✅ conversation_full_history.log                      | master.omega_registry/conversation_full_history.log      | Captures full protocol trail                         |
| ✅ settings.conf.yaml                                | master.omega_registry/settings.conf.yaml                 | Centralized path and config structure                |
| `README_final_registry_release.md` | Release documentation | ✅ This file |

⸻

## Task Summary (Phase Completion Status)

Phase Status Details
📌 Phase 1: Rosetta Stone Reconstruction ✅ Complete entity_id_migration_map.annotated.v4.json
📌 Phase 2: Omega Room Registry Rehydration ⏳ Incomplete Pending after full alpha sensor integration
📌 Phase 3: Alpha Tier Rehydration ✅ Completed and validated alpha_sensor_registry.json generated
📌 Phase 4: Validation & Output Contract ⏳ In Progress Partial: validation logs, sanity checks active

⸻

## Optional Post-Reboot Recovery Actions

 • 🔍 Re-run alpha_sensor_registry_backfill.py if semantic_role, confidence_score_mean, or features need final updates
 • 🧪 Trigger audit script (alpha_sensor_registry.validation_report.json) to confirm entity integrity post-regeneration
 • 🧱 Begin stitching omega_room_registry.json using canonical IDs + alpha groupings
 • 📚 Version/tag this project state for downstream deployment

⸻

## Next Steps & Finalization Plan

### 🔄 Immediate Next Steps

1. **Validate Alpha Sensor Clusters**
   - Run: alpha_sensor_registry.validation_report.json generator
   - Output: validation report and per-cluster pass/fail summary

2. **Rehydrate Omega Room Registry**
   - Script: generate_omega_room_registry.py (or equivalent)
   - Input: alpha_sensor_registry.json, entity_id_migration_map.annotated.v4.json
   - Output: omega_room_registry.rehydrated.json

3. **Rehydrate Alpha Light Registry**
   - Reuse alpha_sensor_registry logic adapted for lights
   - Output: alpha_light_registry.json

### 📍 Major Milestones to Completion

✅ Canonical Omega registry normalized
✅ Alpha sensor registry validated and feature-grouped
⏳ Omega room registry rehydration
⏳ Final validation pass (cross-registry, completeness audit)
⏳ Release bundle: final registries, audit logs, and README

### 🎯 Final Deliverables

- omega_room_registry.rehydrated.json
- alpha_sensor_registry.json (final)
- alpha_light_registry.json
- entity_id_migration_map.annotated.v4.json
- validation_report.json (sensor & room)
- rehydration_delta_log.json
- conversation_full_history.log
- README_final_registry_release.md
- ✅ `README_final_registry_release.md` (emitted 2025-07-11)

---

## ⚠️ Protocol-Confirmed Execution Sequence (Appended for Governance Lock)

### 1. Alpha Sensor Cluster Validation

- Execute the validation report generator for alpha_sensor_registry.
- Confirm cluster integrity and review pass/fail status per cluster.

### 2. Omega Room Registry Rehydration

- Use the designated script (generate_omega_room_registry.py or equivalent).
- Input required files: alpha_sensor_registry.json and entity_id_migration_map.annotated.v4.json.
- Produce omega_room_registry.rehydrated.json as output.

### 3. Alpha Light Registry Generation

- Adapt alpha_sensor_registry processing logic for lighting entities.
- Generate alpha_light_registry.json accordingly.

### 4. Comprehensive Final Validation

- Perform cross-registry audits to ensure completeness and consistency.
- Generate final validation reports covering all registries.

### 5. Release Preparation

- Assemble final artifact bundle including:
  - omega_room_registry.rehydrated.json
  - alpha_sensor_registry.json (final)
  - alpha_light_registry.json
  - entity_id_migration_map.annotated.v4.json
  - validation_report.json (sensor & room)
  - rehydration_delta_log.json
  - conversation_full_history.log
  - README_final_registry_release.md

### 5.2 Alpha Sensor Registry Validation & Freeze (2025-07-11)

- Audit `alpha_sensor_registry.json` for:
  - ≥ 85% clusterable entity coverage
  - No `flag_manual_review` or `role: unknown` entries
  - Full compliance with semantic and structural schema

- Run:

```bash
  source .venv/bin/activate && python run_pipeline.py scripts/validate_alpha_sensor_registry.py
```

 • Emit under /contracts/validation/:
 • validation_report.json
 • cluster_coverage_metrics.json
 • validation_run_checklist.md
 • Freeze for release:
 • Create: rehydration_freeze_alpha.sig
 • Run: rehydration_dryrun_alpha.py (if available)
 • Emit: rehydration_dryrun_summary.json (optional)
 • Update:
 • file_trace_manifest.v1.json
 • file_dependency_matrix.json
 • All patch and changelog logs
 • Validation status must be ✅ PASS before proceeding to omega rehydration.

### Governance Note

This appended execution sequence supersedes prior informal next steps and is locked for compliance review and downstream integration. Any deviations must be formally approved and documented.

---

You’re currently in Phase 1.5–2.5 of the registry rehydration pipeline, right between entity reconciliation refinement and final cluster coverage expansion, with full auditability and validation mechanisms now in place.

Here’s the detailed status by phase and task:

⸻

✅ Phase 1: Rosetta Stone Reconstruction (Entity ID Mapping)

Goal: Map pre-reboot entity IDs to post-reboot ones via fingerprinting
 • ✅ fingerprint_entity_map.json generated
 • ✅ Confidence scores now normalized (confidence_score)
 • ✅ Manual confirmed match bias applied
 • ✅ Penalization heuristics operational (e.g. domain conflict, suffix mismatch)
 • ✅ Patch log + match reasoning now preserved
 • ✅ gray_zone_matches.csv and unmatched_entity_trace.json generated
 • ⚠️ Recovered manual_confirmed_matches.json after an accidental overwrite

⸻

✅ Phase 2: Alpha Sensor Registry Generation

Goal: Construct alpha_sensor_registry.json using reconciled matches
 • ✅ emit_alpha_sensor_registry.py run
 • ✅ Clusters generated and include role, semantic_role, confidence_score_mean, match_methods, etc.
 • ✅ Features (e.g., timeout, sensitivity) are correctly nested within primary clusters
 • ✅ Full validation run completed — no invalid clusters
 • ✅ Normalized to canonical schema
 • ✅ Penalization and patch logic operational
 • ✅ YAML config fully rewired (settings.conf.yaml)

⸻

✅ Phase 2.5: Cluster Coverage Audit

Goal: Detect and explain missing sensor coverage
 • ✅ audit_cluster_coverage.py executed
 • ✅ Initial result: 63 clusterable entities, 4 clustered → 6.35% coverage
 • ✅ Unclustered trace (unclustered_entity_trace.json) now fully available in /output/data/
 • ✅ Runtime-safe logging implemented (doesn’t overwrite live data)
 • ⚠️ Remaining unclustered entities suggest underutilized or misclassified inputs

⸻

⏳ Phase 3: Omega Room Registry Rehydration

Goal: Use validated entity ID map + alpha sensor clusters to rebuild
 • 🟡 Prerequisite: confirm alpha sensor registry is complete enough for room mapping
 • 🟡 Requires: generate_omega_room_registry.py to be validated and run
 • 🟡 Needs pre-pass to crosscheck entity_id_migration_map.annotated.v4.json usage

⸻

⏳ Phase 4: Alpha Light Registry Rehydration

Goal: Build light registry clusters just like sensors
 • ⏳ Awaiting audit + clustering logic adjustments
 • 🚫 Not yet generated

⸻

🔁 Currently In Progress
 • 🔧 Repairing match logic and role inference to improve clustering coverage
 • ✅ Config patch: new role mappings and penalization logic (applied and active)
 • ✅ Manual confirmation preservation logic now live (no more overwrites)
 • 🟡 Suggested next step: rerun reconciliation and clustering with new scores

⸻

Here’s the optimal path forward, balancing precision, effort, and impact across the registry pipeline:

⸻

✅ Recommended Strategy: Backtrack + Rehydrate (Selective Full Path)

🎯 Objective:

Systematically recover missing clusters and entity mappings by:

 1. Rebuilding alpha_sensor_registry.json with full coverage,
 2. Rehydrating the omega_room_registry.rehydrated.json from that corrected input.

⸻

🔄 Phase 1: Reconstruct Alpha Sensor Registry from Source-of-Truth

Step 1.1 — Rebuild clusters from core.entity_registry
 • Run or re-patch emit_alpha_sensor_registry.py to:
 • Parse all clusterable entities using the enriched settings.conf.yaml role rules
 • Leverage updated scoring & penalization logic
 • Reconstruct alpha_sensor_registry.json from scratch with complete propagation

Step 1.2 — Include “features” as sub-entries (already partly implemented)
 • Tuning params like sensitivity, timeout, illumination should not appear at top-level, but as .features[] within the parent cluster
 • This avoids polluting the Omega room registry with non-functional or auxiliary sensor groups

Step 1.3 — Validate
 • Run audit_cluster_coverage.py to confirm coverage is ≥90% of all clusterable entities
 • Confirm entries are annotated with:
 • semantic_role
 • tier: alpha
 • populated post_reboot_entity_ids

⸻

🏠 Phase 2: Rerun Omega Room Registry Generator

Step 2.1 — Patch and rerun generate_omega_room_registry.py
 • Ensure it:
 • Pulls from newly reconstructed alpha_sensor_registry.json
 • Aggregates all clusters by area
 • Excludes clusters with incomplete: true or area: unknown (log these separately)

Step 2.2 — Validate output:
 • All major areas from core.area_registry must appear
 • Each room must contain multiple sensor entries if clustered
 • Validate entity count and per-room cluster distribution

⸻

📈 Why This Plan?

Strategy Pros Cons
✅ Reconstruct & Rehydrate Ensures clean, validated rebuild from canonical source More compute, needs patching
Patch current Omega Faster, but risks compounding a sparse or incomplete dataset Patch complexity, fragility
Manual Top-Up Quick stopgap via hand-picked clusters Not sustainable, not scalable

This rebuild-based strategy gives us the highest confidence in the registry completeness, lowest maintenance burden, and aligns with the Promachos protocol of deterministic data reconstruction.

⸻

### Registry Integrity & Rebuild Roadmap — 2025-07-08

---

## ❗ Concrete Problems Identified (Registry Hydration Health Audit)

| Issue | Description | Status |
|-------|-------------|--------|
| ⛔ Shallow Alpha Sensor Registry | `alpha_sensor_registry.json` lacks true area propagation, meaningful match methods, and fully nested features. This invalidates downstream registries. | Unusable for room mapping |
| ⛔ Misleading Confidence Scores | Score math is clean, but semantic lineage (e.g. `match_methods`, `source`) is untracked or empty, undermining trust. | Structural but misleading |
| ⛔ Cluster Schema Fragmentation | Incomplete propagation of `tier`, `role`, `features` and source tags into clusters. No cluster audit schema defined. | Blocks coverage validation |
| ⛔ Filesystem Sprawl | Dozens of overlapping JSON files and logs with weak naming standards. Ambiguous roles and generations (v1, v4, etc.). | Prevents governance clarity |
| ⛔ Patch Dependency Drift | Patches are not traceable to output changes. Files are reused without checksum, versioning, or lineage. | Undermines auditability |

---

## ✅ Systemic Solutions and Interventions

### 🧪 [PHASE 4] Final Registry Generation & Validation

---

## 🧠 Artifact Evaluation and Minimalism Plan — 2025-07-08 Update

All new or proposed files were critically reviewed to prevent sprawl, increase traceability, and ensure necessity.

### ✅ Approved Additions

| File | Reason | Notes |
|------|--------|-------|
| `cluster_schema_validation_report.json` | Required to validate completeness and structural soundness of alpha clusters | Must pass before omega rehydration |
| `registry_rehydration_archive/archive_20250708/` | Cleanup destination for deprecated/ambiguous artifacts | Will be auto-populated during directory audit |
| `file_dependency_matrix.json` | Script/file interaction mapping for cleanup | Used by Copilot for safe refactoring |
| `file_trace_manifest.v1.json` | Inventory of current files and usage roles | Drives archive/move decisions |
| `README_final_registry_release.md` | Required for final handoff | Output-only artifact |

### 🟡 Consolidation Actions

| Proposed File | Now Consolidated Into | Notes |
|---------------|------------------------|-------|
| `role_rule_matrix.audit.json` | `validation_report.json` → `role_rule_audit` key | Single validation target |
| `migration_map_role_gap_trace.json` | `migration_map_role_coverage_report.json` → `gap_trace` block | No new file needed |
| `auto_candidate_matches.csv` | `gray_zone_matches.csv` → new `suggested=true` column | Avoids CSV redundancy |
| `cluster_schema_validator.py` | Logic folded into `validate_alpha_sensor_registry.py` | Prevents script sprawl |

### ❌ Rejected Additions

| File | Reason |
|------|--------|
| `generate_cluster_schema.yaml` | Schema should be embedded in settings.conf.yaml |
| `registry_generation_gatekeeper.py` | Gatekeeping logic belongs in existing validation pipeline |
| `cluster_rule_enforcement.json` | Overlaps with validation report, unnecessary |
| `copilot_output_summary.json` | Duplicates `copilot_patchlog_overview.log` |

---

This artifact governance block supersedes earlier informal proposals and is enforced under Strategos–Promachos protocol.

---

### 🔁 [PHASE 1] Reconstruct Alpha Sensor Registry from Truth

- Rebuild `alpha_sensor_registry.json` using:
  - `core.entity_registry`
  - `core.device_registry`
  - `settings.conf.yaml` role rules
  - `entity_id_migration_map.annotated.v4.full.json`

- Restore proper cluster roles, tier, features nesting, area/device propagation
- Confirm ≥90% clusterable entity coverage with `audit_cluster_coverage.py`

---

### 🧱 [PHASE 2] Define and Enforce Cluster Schema

- Introduce validator: clusters must have:
  - unique `source_clusters`
  - non-empty `features`
  - `match_methods`, `semantic_role`, `tier`, `confidence_score_mean`
  - valid `area` and `post_reboot_entity_ids`

- Output: `cluster_schema_validation_report.json`

---

### 🧹 [PHASE 3] Project Directory Cleanup & Refactoring

- Create full manifest of:
  - Scripts, JSON files, YAML files, Logs
  - Sorted by: [used], [referenced], [redundant], [obsolete]

- Apply consistent path structure:

```bash
  input/          # all source registries, raw from HA
  output/         # all generated/validated outputs
  archive/        # everything deprecated or superseded
  scripts/        # all active Python scripts
  logs/           # runtime and patch execution logs
  meta/           # manifests, governance maps
```

- Move unused or unverifiable files to:
  `registry_rehydration_archive/archive_20250708/`

- Use Copilot to:
  - Parse all scripts for file references
  - Emit dependency map and update paths where necessary
  - Validate which files are read or written by each module

---

### 🧪 [PHASE 4] Final Registry Generation & Validation

- Rerun:
  - `generate_omega_room_registry.py`
  - `emit_alpha_light_registry.py`

- Produce:
  - `omega_room_registry.rehydrated.json`
  - `alpha_light_registry.json`

- Run:
  - `validate_alpha_sensor_registry.py`
  - `room_registry_completeness_audit.py`

- Confirm:
  - Cross-registry consistency
  - Room–sensor coverage
  - Match traceability

---

### 🔒 Manifest and Governance Lock

This section supersedes the prior planning block and anchors the canonical recovery strategy under Promachos protocol lock. All downstream actions (script execution, renaming, archival) must trace back to this governance header.
